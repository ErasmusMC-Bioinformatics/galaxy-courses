\documentclass[11pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}

\usepackage{graphicx}
\usepackage[english]{babel}
\usepackage[margin=0.85in]{geometry}
\usepackage{amsmath}
\usepackage{natbib}
\usepackage{hyperref}
\bibliographystyle{plainnat}
\usepackage{setspace}

\input{../configure.tex}% Configurations should be changed in this file

\begin{document}
\title{ \textit{\institute}\text{ }Galaxy Training: RNA-Seq DGE analysis \\
{ \large This practical aims to familiarize you with the Galaxy RNA-Seq analysis, the FastQ format and data collections (pairs).}}

\author{ \authors }
\maketitle

%\newpage
%\tableofcontents
%\newpage

%\doublespacing

\section*{Introduction}
Due to the rapid development of Galaxy, screenshots and results may be out of date. If you experience something like this, please report it as a bug at \url{https://github.com/ErasmusMC-Bioinformatics/galaxy-courses/issues}.

\input{../Preparations.tex}% Preparations should describe how to access which server

% Module QC/QA:
\input{Galaxy_RNA-Seq_DGE_manual_Module_QC.tex}

% Module alignment:
\section{RNA-Seq: alignment}
To make more sense of the RNA-Seq data, we try to find the sequences back in the reference genome (mapping, aligning). The reference
genome should represent the most common sequence of the chromosomes of the human population. Please read the first paragraph (3 scentences) of the following url: \url{http://en.wikipedia.org/wiki/Reference_genome}
\begin{itemize}
	\item On how many individuals is hg19 based?
\end{itemize}
For RNA-Seq we need specialized RNA aligners, able to cope with gaps that originate from splicing. For this exercise we will make use of a tool called RNA-STAR. There are quite some of these aligners around. We will make use the tool ``\textit{\underline{HISAT2} A fast and sensitive alignment program}''. Load the aligner, select the following settings and leave the rest on default, and run an alignment for \textit{miR-23b (clean)} and \textit{control sample (clean)}. \textbf{Alignment is a computational very very heavy task so do NOT re-run or load it twice, or you have to give a treat:}\\
\includegraphics[width=\textwidth]{figures/alignment_01.png}\\
Please rename the \textit{HISAT2 on ...} to ``\textit{HISAT2 on miR-23b}'' and ``\textit{HISAT2 on control sample}''.
If the alignments do not have their \textbf{database} set, change it to hg19 as follows:\\
\includegraphics[width=\textwidth]{figures/alignment_02.png}\\
To get some general alignment statistics, run the tool ``\textit{\underline{Flagstat} tabulate descriptive stats for BAM datset}'' on \textit{HISAT2 on miR-23b}.
\begin{itemize}
	\item How many reads are multi-mapping?
\end{itemize}
For now we have only seen FastQ data and some summaries. To get an idea of what has been measured during the experiment, we can visualise the alignment. So, in the HISAT2 step we have been looking into hg19 where these sequences can be found in the reference genome, and this information is stored in those bam files. Import from the Shared Data library (TraIT Galaxy Training Materials $\rightarrow$ TraIT Galaxy Training - 3: RNA-Seq Tuxedo Pipeline) the file ``\textit{ucsc\_refseq.gtf}'' into your history. Start the built-in visualization Trackster at one of the alignments (make sure the dataset has \textbf{hg19} as database because we aligned to that):\\
\includegraphics[scale=0.55]{figures/alignment_03}\\
Give it a name, press \textit{Create} and you will see a yellow bar, indicating that the bam file is being prepared. This means that the bam file is being convert into a file format that the browser can visualize. \includegraphics[width=\textwidth]{figures/alignment_04.png}\\
When this job is done, and it looks like this, make sure you save it:\\
\includegraphics[width=\textwidth]{figures/alignment_05.png}\\
To add the other alignment, press the \textbf{[+]}-button:\\
\includegraphics[width=\textwidth]{figures/alignment_06.png}\\
Now select the other alignment and press \textit{Add} and save it again:\\
\includegraphics[width=\textwidth]{figures/alignment_07.png}\\
Remark that this is truncated data and you are supposed to see barely anything in here. Go to \textit{chr16}, to region \verb|chr16:15696870-15745667|.
\begin{itemize}
	\item Can you see where the introns and exons are located?
\end{itemize}
To help you answer this question, you can add ``\textit{ucsc\_refseq.gtf}'' that will visualize the exons and gene structure of a refseq gene annotation. It will only be visible if its database of the history item is set to hg19. Again, ensure this visualization is saved:\\
\includegraphics[width=\textwidth]{figures/alignment_08.png}\\
\begin{itemize}
	\item Can you go to \verb|chr15:60688011-60688099|, and explain what is going on there?
\end{itemize}
In the last question you can clearly see that you can observe biological facts from alignments where you couldn't extract this from the plain fastq files. Because looking through these alignments is way to much work and prone to errors, we use these bam files for a variety of computer programs to estimate metrics. These metrics can be insert size, expression levels, indel ratio's, etc., that may be used to test different hypotheses.

%The insert size is the size between the mate pairs in the alignment. Since the fragments (original part of RNA) are size selected, this should also be reflect in the alignment. Leave Trackster and run the Picard tool: ``Insertion size metrics for pairedd data''.

% @ todo
%- Ask question about insert size

\section{Expression analysis (basic)}
There are several tools able to do differential gene expression analysis, like CuffDiff, EdgeR and DESeq2, all available for Galaxy.
For this analysis we will start using the ``\textit{Tuxedo}'' pipeline, using CuffDiff.
\\
-- samtools header (use std samtools preferably)\\
-- cuff stuff


\section{Expression analysis advanced}
\subsection{Estimating gene expression}
For this practical we need a RNA-seq alignments we previously made in the basic expression analysis: ``\textit{HISAT2 on miR-23b.bam}''. If you did not do that practical, you can find it in the supplementary material: \\
\datalibrarydirrnaseqadvanced $\rightarrow$ HISAT2\\
Ensure that the file is annotated at reference genome hg19. To estimate expression in RNA-Seq, we can simply count the number of reads that are aligned to each gene from the list of candidate genes. Therefore you also need to import:
\datalibrarydirrnaseqtuxedo $\rightarrow$ ucsc\_refseq.gtf\\
This list is provided as a GTF/GFF file. There are a variety of tools available for counting reads. FeatureCounts is one of the fastest and it works directly using BAM files. If you search for
``\textit{\underline{featureCounts} Measure gene expression in RNA-Seq experiments from SAM or BAM files.}'' in the Tools menu, you can find the wrapper by the name:\\
\includegraphics[width=\textwidth]{figures/expression_01.png}\\
Before we proceed, we would like to know whether the analysis has been performed correctly. Therefore we take a look at featureCountsâ€™ output-summary file ``\textit{featureCounts on \ldots}'':
\begin{itemize}
	\item How many reads are \textit{Assigned}?
	\item How many reads are \textit{UnAssigned (sum of all)}?
\end{itemize}
The flagstat exercise told us we had 18258 reads in total. This should match with the total number of reads in the summary file as well. If we want to look at a particular gene, we truncate the large table and only show the row with the gene of interest. To filter a tabular file we proceed with the following Galaxy tool: 
\textit{\underline{Filter} data on any column using simple expressions}:\\
\includegraphics[width=\textwidth]{figures/expression_02.png}\\
\begin{itemize}
	\item How many reads are aligned to ANXA2?
	\item What gene has the highest gene count (tip: use \textit{sort})?
\end{itemize}

\subsection{Expression analysis: Low sequencing depth}
In the previous exercise we found which gene had the highest readcount, but what does it mean if this gene always has a high readcount in every sample? To say something about expression levels, we should say it in a context relative to other expression levels. Therefore, we need normalization and apply statistical testing. A popular package that allows to do this is EdgeR.

In the following analyses you will determine the differentially expressed genes in the MCF7-cell line between samples that have been treated with the hormone $\beta$-estradiol (E2) and those that were left as control. For this analysis we will make use of samples all taken from this cell line. In the corresponding article, the statistical power has been estimated at different sequencing depths (subsampling) and with a different number of replicates. Before we proceed, please read the abstract of the following article:
\url{http://dx.doi.org/10.1093/bioinformatics/btt688}\\
Tip: Look up where MCF7 cell lines originate from if you don't know this.\\
\\
In the article it is stated that for differential gene expression analysis it is very important to have a high number of replicates per condition. We will repeat a part of their experiment, to illustrate their findings. For this practical we have the readcounts for a sequencing depth of $\sim$30M (full), 10M and 5M, for each replicate, already made available. Each analysis in this assignment
will be to determine the number of differentially expressed (DE) genes and add this number to Table \ref{tab:dge_ad_01}:
\begin{table}[]
\centering
\caption{results of DGE analysis}
\label{tab:dge_ad_01}
\begin{tabular}{ | l | l | r | }
\hline
Replicates & Seq. Depth & Significant DE genes \\
\hline
0          & 0          & 0\quad\quad \\
7          & 5,000,000  & \verb|.......| ? \\
7          & 10,000,000 & \verb|.......| ? \\
7          & 30,000,000 & \verb|.......| ? \\
5          & 30,000,000 & \verb|.......| ? \\
\hline
\end{tabular}
\end{table}
Import the following files from data library \datalibrarydirrnaseqadvanced :
\begin{itemize}
	\item[] \verb|GSE51403_expression_matrix_5M_coverage.txt|
	\item[] \verb|GSE51403_expression_matrix_10M_coverage.txt|
	\item[] \verb|GSE51403_expression_matrix_full.txt|
	\item[] \verb|GSE51403_design_matrix_subsampled.txt|
\end{itemize}
Please take a look at the file GSE51403\_design\_matrix\_subsampled.txt.
\begin{itemize}
	\item Given that the first column lists the names of the samples and the second column the samples' corresponding condition, how many conditions does the experiment have?
\end{itemize}

%\bibliographystyle{natbib}
%\bibliographystyle{plainnat}

%\newpage

\vspace{-1.5em}
\bibliography{references}

\end{document}